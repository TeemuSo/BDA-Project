---
title: "ProjectFirst"
author: "Teemu Sormunen, Abdullah GÃ¼nay, Nicola Brazzale"
date: "11/18/2020"
header-includes:
  - \usepackage[numbers]{natbib}
# Citations
bibliography: ./citations/sources.bib
# csl: ./citations/vancouver-brackets.csl unnecessary?

output: 
  pdf_document:
    toc: true
    toc_depth: 2
    number_sections: true
    citation_package: natbib

---

\newpage

# Introduction

## The problem
Cardiovascular Heart Disease (CHD) is the top reason causing 31% of deaths globally. Pakistan is one of the countries where CHD is increasing significantly, and previous studies do not directly apply to Pakistani area due to different diet patterns.
[@origpaper]

## The motivation
The motivation is to estimate death rates and major risk factors for heart failure to have __predictive power(?????????)__. 
[@origpaper]

## Modeling idea

Modeling is done with package brms, which is a interface for non-linear multivariate multilevel models in Stan.


# Dataset

## Term explanation  

Some of the terms in the dataset might not be familiar, and they are opened briefly here.

* **Creatine phosphokinase (CPK)**  
CPK is an enzyme, which helps to regulate the concentration of adenosine triphosphate (ATP) in cells. ATP is responsible for carrying energy. If the CPK level is high, it often means that there has been an injury or stress on a muscle tissue. Although CPK is one the oldest markers of heart attack, high CPK might also indicate of acute muscle injury along with acute heart problems.  
Normal level of CPK ranges from 20 to 200 IU/L [@phosphokinase]

* **Ejection fraction (EF)**  
EF is a measurement in percentage which describes how much blood left ventricle pumps out of heart with each contraction.
Low EF might indicate potential heart issues.  
Normal EF is 50 to 70 percent, while measurement under 40 percept might be an indicator of heart failure or cardiomyopathy. [@ef]  

* **Platelets**  
Platelets are small cell fragments which can form clots. 
Too many platelets can lead to clotting of blood vessels, 
which in turn can lead to heart attack. Too 
Normal range of platelets is from 150 000 to 450 000. [@platelets]

* **Serum creatinine**  
When creatine breaks down, it forms a waste product called creatinine. Kidneys normally remove creatinine from body. Serum creatinine measures level of creatinine in the blood, indicating the kidney health. High levels of creatinine might indicate a kidney dysfunctioning.  
Normal level of creatinine range from 0.9 to 1.3 mg/dL in men and 0.6 to 1.1 mg/dL in women who are 18 to 60 years old. [@creatinine_serum]

* **Serum sodium**  
Serum sodium measures the amount of sodium in blood. Sodium enters blood through food and drink, and leaves by urine, stool and sweat. Too much sodium can cause blood pressure, while too little sodium can cause nausea, vomiting, exhaustion or dizziness.  
Normal levels of serum sodium are 135 to 145 mEq/L, according to Mayo Clinic. There are however different interpretations of "normal".[@sodium]

## Dataset introduction

The dataset of 299 patients was produced as a result of study [@origpaper] from Pakistani's city Faisalabad. All of the patients were over 40 years old, each having ventricular systolic dysfunction. This means that patient has poor left ventricular ejection fraction.
The dataset has 105 women, and 194 men.
EF, serum creatinine and platelets are categorical variables, and age, serum sodium and CPK are continuous variables.  
Statistical analysis by [@origpaper] found age, creatinine, sodium, anemia and BP as significant variables.

\newpage
# Packages
```{r setup, include=FALSE}
library(tidyverse)
library(ggplot2)
library(corrplot)
library(brms)
```

Load data
```{r}
file.name <- './data/heart_failure_clinical_records_dataset.csv'
heart <- read_csv(file.name)
```

Plot histograms

```{r}
ggplot(heart, aes(x=age)) + geom_histogram(aes(fill=as.character(sex)), bins = 30) + labs(fill = "Sex")

ggplot(heart, aes(x=age)) + geom_histogram(aes(fill=as.character(DEATH_EVENT)), bins = 30) + labs(fill = "Death")

ggplot(heart, aes(x=creatinine_phosphokinase)) + geom_histogram(aes(fill=as.character(DEATH_EVENT)), bins = 30) + labs(fill = "Death")

ggplot(heart, aes(x=ejection_fraction)) + geom_histogram(aes(fill=as.character(DEATH_EVENT)), bins = 30) + labs(fill = "Death")

ggplot(heart, aes(x=platelets)) + geom_histogram(aes(fill=as.character(DEATH_EVENT)), bins = 30) + labs(fill = "Death")

ggplot(heart, aes(x=serum_creatinine)) + geom_histogram(aes(fill=as.character(DEATH_EVENT)), bins = 30) + labs(fill = "Death")

```





Correlation matrix

```{r}
pred <- c("high_blood_pressure", "age", "sex", "creatinine_phosphokinase", "diabetes", "ejection_fraction", "platelets", "serum_creatinine", "serum_sodium", "smoking", "anaemia") 
target <- c("DEATH_EVENT")
#formula <- paste("DEATH_EVENT ~", paste(pred, collapse = "+"))
p <- length(pred)
n <- nrow(heart)
x = cor(heart[, c(target,pred)]) 
corrplot(x)
```
# BRMS modeling

In BRMS modeling, the parameters are said to either be population level or group level. Population level probably means the same thing as regular parameters in our course, and group level equals hyper parameters (?????????????????)

Brms example, investigate results based on age.
**Family argument** specifies the distribution family of the output.  

**Prior argument** for each of the parameters, in this case only age. One can set different priors for each population level parameter, or group level parameter.
```{r}
# Split test and train data
test.size <- 0.3
train.indice <- sample(nrow(heart), nrow(heart)*(1-test.size))
train.data <- heart[train.indice,]
test.data <- heart[-train.indice,]

# Fit model based on age
fit <- brm(formula = DEATH_EVENT ~ age,
           data = train.data,
           family = bernoulli(),
           prior = c(set_prior("normal(50,50)", coef="age")),
           refresh=0
           )
```
Analyze stan code
```{r}
summary(fit)
stancode(fit)
```
Predict survival
```{r}
preds <- round(predict(fit, newdata = test.data))[1]
pred.corr <- preds == test.data$DEATH_EVENT

acc <- length(pred.corr[pred.corr == TRUE])/nrow(test.data)
acc
```

```{r}
#PRIORS ?
# 1 LINEAR MODEL WITH VARIABLE SELECTION
# 2 LINEAR MODEL WITH ALL VARIABLES
# HIERARCHICAL - in the Titanic one a hier. model have been used so we can use that one for reference

# All models with bernoulli outcome (1-0, death or not)
```

# References